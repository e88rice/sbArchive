<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{/layout/layout.html}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" defer></script>
<style layout:fragment="style">
    .readBoard_form {
        margin: 0 auto;
        padding-top: 150px;
        width: 500px;
    }

    /* 여기서부터 댓글 관련 css */
    .replyItem {
        list-style: none;
    }
    .reply_page_container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        width: 65vw;
        margin-top: 10px;
    }
    .reply_list_paging_wrap {
        display: flex;
        list-style: none;
    }
    .reply_page_wrap, .reply_page_prev, .reply_page_next {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 40px;
        margin: 0 10px;
        width: 40px;
        height: 40px;
    }
    .active {
        font-weight: bold;
    }
</style>

<div layout:fragment="content">
    <form action="/board/readBoard" method="get" class="readBoard_form">
        <div class="row mt-3">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        게시물
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <span class="input-group-text">번호</span>
                            <input type="text" class="form-control" th:value="${dto.boardId}" readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">제목</span>
                            <input type="text" class="form-control" th:value="${dto.title}" readonly>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text">닉네임</span>
                            <input type="text" class="form-control" th:value="${dto.nickname}" readonly>
                        </div>


                        <div class="input-group mb-3">
                            <span class="input-group-text">내용</span>
                            <textarea class="form-control col-sm-5" rows="5" readonly>[[${dto.content}]]</textarea>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text">아이디</span>
                            <input type="text" class="form-control" th:value="${dto.userId}" readonly>
                        </div>

                        <div class="input-group mb-3">
                            <span class="input-group-text">좋아요</span>
                            <input type="text"  class="form-control" th:value="${dto.likeUp}" readonly>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text">조회수</span>
                            <input type="text" class="form-control" name="hit" th:value="${dto.hit}" readonly>
                        </div>


                        <div class="input-group mb-3">
                            <span class="input-group-text">addDate</span>
                            <input type="text" class="form-control" th:value="${#temporals.format(dto.addDate,'yyyy-MM-dd HH:mm:ss')}" readonly>
                        </div>

                    </div>
                </div><!-- end card body -->
                <div class="my-4">
                    <div class="float-end">
                        <div class="float-end">
                            <button type="submit" class="btn btn-primary">수정</button>
                            <button type="button" class="btn btn-secondary">목록</button>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </form>



    <!-- 댓글 등록 영역 -->
    <script src="/js/reply/reply.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <div style="margin: 50px;">
        <div style="border: 2px solid #d3d3d3; border-radius: 10px; width: 65vw; padding: 10px; margin: 0 auto;">
            <div>
                <div style="display:flex; flex-direction: row;">
                    <input type="hidden" name="nickname" class="anickname" th:value="${#authentication.principal.nickname}">
                    <input type="hidden" name="userId" class="auserId" th:value="${#authentication.principal.username}">
                    <div class="anickname">[[${#authentication.principal.nickname}]]<span class="auserId">([[${#authentication.principal.username}]])</span></div>
                    <textarea placeholder="댓글을 입력해 주세요." name="content" class="acontent form-control" style="padding: 10px; margin: 5px"></textarea>
                    <button type="button" class="btn btn-primary addBtn" style="width: 70px; height: 40px; margin-top: 15px">등록</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 댓글 등록 영역 끝 -->

    <!-- 댓글 리스트 출력 -->
    <div style="width: 65vw; margin: 0 auto">
        <div>
            <i class="fa-solid fa-comment fa-flip-horizontal"></i><span style="margin-left: 10px;">댓글 총 ㅇ개</span><!--<span>총 [[${dto.replyCount}]]개</span>-->
            <a class="refreshBtn"><i class="fa-solid fa-arrow-rotate-right" style="color: #000000;"></i></a>
            <ul class="list-group replyList" style="margin: 10px">
                <!-- 댓글 출력 -->
            </ul>
        </div>
        <div>
            <div class="reply_page_container">
                <ul class="reply_list_paging_wrap replyPaging">
                    <!-- 댓글 페이징 출력 -->
                </ul>
            </div>
        </div>

    </div> <!-- 댓글 목록 끝 -->

</div>

<script layout:fragment="script" th:inline="javascript">

    const frm = document.querySelector('form');
    const boardId = [[${dto.boardId}]]; // board Idx
    const link = [[${pageRequestDTO.getLink()}]];

    document.querySelector(".btn-primary").addEventListener("click",function () {
        self.location = `/board/modify/${boardId}`
    },false);

    document.querySelector(".btn-secondary").addEventListener("click",function (e) {
        location.href = `/board/boardList?${link}`;
    });




    // 여기서부터 댓글 관련 자바스크립트
    // 새로고침 이벤트
    const refreshBtn=document.querySelector('.refreshBtn');
    refreshBtn.addEventListener("click", function(e) {
        location.reload(); // 가장 마지막 페이지로 이동
    });

    // 댓글 등록 관련 자바스크립트
    const acontent=document.querySelector(".acontent");
    const auserId=document.querySelector(".auserId");
    const anickname=document.querySelector(".anickname");
    const addBtn=document.querySelector(".addBtn");

    // 댓글 등록 버튼 클릭 이벤트
    addBtn.addEventListener("click", function(e) {
        alert("addBtn 클릭함");
        const replyObj={boardId:boardId, content:acontent.value, userId:auserId.value, nickname:anickname.value};

        addReply(replyObj).then(result => { // reply.js(axios)
            alert(result.data.replyId); // 확인용
            acontent.value = ''; // 초기화
            location.reload(); // 새로고침
            printReplies(1, 10, true); // 가장 최근 댓글 있는 페이지로 이동
        }).catch(e => {
            alert("댓글 등록에 문제 생김");
        });
    });
    // 여기까지 댓글 등록 관련 자바스크립트

    // 여기서부터 댓글 리스트 출력 관련 자바스크립트
    const replyList = document.querySelector('.replyList'); // 댓글 목록 DOM
    const replyPaging = document.querySelector('.replyPaging'); // 페이지 목록 DOM

    function printReplies(page, size, goLast) {
        getReplyList({boardId, page, size, goLast}).then( // reply.js(axios)에 정보 넘겨주고 페이징된 데이터 받아옴
            data => {
                console.log("data: "+data);
                printReplyList(data.dtoList); // pageResponseDTO의 dtoList
                printPages(data);
            }
        ).catch(e => {
            console.error();
        });
    }
    printReplies(1, 10, true); // 무조건 댓글 맨 뒷페이지로 시작

    // 댓글 a 태그를 눌렀을 때 페이지 이동
    let page = 1;
    let size = 10;

    // 페이지 목록 클릭 이벤트
    replyPaging.addEventListener("click", function (e){
        e.preventDefault();
        e.stopPropagation();

        const target = e.target;

        if(!target || target.tagName != 'A') return; // 타겟이 아니거나 a 태그가 아니면 종료

        const pageNum = target.getAttribute("data-page");
        page = pageNum;
        printReplies(page, size);
    });

    function printPages(data) { // 댓글 페이징 목록 출력
        // pagination
        let pageStr = ''; // 페이지를 이동하기 위한 a 태그들을 담을 변수
        if(data.prev) { // 받아온 data의 prev 값이 true라면 이전 버튼 활성화
            pageStr += `<li class="reply_page_prev"><a data-page="${data.start - 1}">이전</a></li>`;
        }
        for(let i = data.start; i <= data.end; i++) {
            // 현재 페이지면 active 클래스 추가
            pageStr += `<li class="reply_page_wrap ${i === data.page ? "active" : ""}">
                    <a data-page="${i}">${i}</a></li>`;
        }
        if(data.next) { // 받아온 data의 next 값이 true 라면 다음 버튼 활성화
            pageStr += `<li class="reply_page_next"><a data-page="${data.end + 1}">다음</a></li>`
        }
        console.log(pageStr);
        replyPaging.innerHTML = pageStr; // 데이터를 전달받아 완성된 페이지 이동 a 태그들을 HTML 요소로 추가
    }

    function printReplyList(dtoList) {
        let str = '';
        if (dtoList && dtoList.length > 0) {
            for (const dto of dtoList) { // dtoList를 순회하면서 댓글마다 아래에 폼에 담아 HTML 요소로 추가
                let date=(dto.addDate===dto.modDate) ? dto.addDate : (dto.modDate+" (수정됨)");
                console.log(date);

                str +=`
                <li class="replyItem" data-replyId="${dto.replyId}">

                    <div class="list" style="display: flex; width: 65vw; justify-content: space-between; border-bottom: 1px solid #d3d3d3; padding-bottom: 10px">
                        <div class="img" style="width: 12%">
                            <img style="padding: 20px 0; width: 50px; height: 90px;" th:src="@{/img/12d5fb18-37a5-480b-8d0b-e102ba20a069_pic7.png}" alt="">
                        </div>

                        <div style="display: flex; flex-direction: column; width: 85%">
                            <div style="display: flex; justify-content: space-between; height: 60px; padding: 20px 0">
                                <div>${dto.nickname}(${dto.userId})</div>
                                <div>
                                    <!-- 수정/삭제 버튼은 thymeleaf 사용해서 로그인정보의 아이디와 댓글 작성자 아이디가 일치할 시 보여주게 바꿀 거임 -->
                                    <a class="replyModBtn">수정</a>
                                    <a class="replyRemoveBtn">삭제</a>
                                    <!-- 신고 버튼은 thymeleaf 사용해서 로그인정보의 아이디와 댓글 작성자 아이디가 일치하지 않을 경우에만 보이게 바꿀 거임 -->
                                    <a class="replyReportBtn">신고</a>
                                </div>
                            </div>

                            <div style="overflow: auto">${dto.content}</div>
                            <div style="color: gray; font-size: 12px">${date}</div>
                        </div>
                    </div>

                    <!-- 댓글 수정 폼 -->
                     <div style="display: none; border-bottom: 1px solid #d3d3d3; padding:20px; width: 65vw;" class="replyModifyForm">
                        <div>
                            <div>${dto.nickname}(${dto.userId})</div>
                        </div>
                        <div style="display:flex; flex-direction: row;">
                            <textarea placeholder="댓글을 입력해 주세요." name="content" class="mcontent form-control" style="padding: 10px; height: auto">${dto.content}</textarea>
                            <button type="button" style="width: 60px; height: 40px; margin: 10px" class="btn btn-primary modBtn">수정</button>
                        </div>
                     </div>
                </li>
               `
            }
        }
        replyList.innerHTML = str;

        // 댓글 삭제 버튼 클릭 이벤트
        document.querySelectorAll('.replyRemoveBtn').forEach(function(replyRemoveBtn) {
            replyRemoveBtn.addEventListener('click', function(e) {
                // a 태그의 parent.parent인 li에 data-replyId 속성 부여
                const replyId = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("data-replyId");
                removeReply(replyId).then(result => { // reply.js(axios)
                    if(!confirm("정말 삭제하시겠습니까?")) return;
                    alert(result.replyId + " 번 댓글이 삭제되었습니다."); // 확인용. 나중에 지울 거임
                    location.reload(); // 페이지 새로고침
                }).catch(e => {
                    console.log(e);
                });
            });
        });

        // 댓글 수정 버튼 클릭 이벤트
        document.querySelectorAll('.replyModBtn').forEach(function(replyModBtn) {
            replyModBtn.addEventListener('click', function(e) {
                alert("replyModBtn 클릭");
                // a 태그의 parent.parent인 li에 data-replyId 속성 부여
                const replyId = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.getAttribute("data-replyId");

                const list = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector('.list'); // 나중에 수정 버튼 누르면 해당 댓글 숨기게, 해당 댓글 수정 폼은 보이게 만들 거임
                const replyModifyForm = e.target.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector('.replyModifyForm'); // 해당 댓글 수정 폼
                const mcontent = replyModifyForm.querySelector('.mcontent');
                const modBtn = replyModifyForm.querySelector('.modBtn');

                getReply(replyId).then(reply => { // reply.js(axios)로 해당 댓글 정보 가져오기
                    console.log(reply); // 제대로 가져왔는지 확인용
                    replyModifyForm.style.display = 'block'; // replyModifyForm이 보이게
                    list.style.display='none';
                }).catch(e => alert('댓글 가져오기(getReply) 실패'));

                modBtn.addEventListener("click", function(e) { // 수정 완료 버튼 클릭 이벤트
                    alert("수정 완료 버튼이 클릭되었습니다"); // 버튼 눌렸는지 확인용
                    const replyObj={content:mcontent.value, replyId:replyId};
                    modifyReply(replyObj).then(result => { // reply.js(axios)로 해당 댓글 수정 post
                        alert(result.replyId + '번째 댓글이 수정되었습니다.'); // 확인용
                        mcontent.value = ''; // 초기화
                        replyModifyForm.style.display = 'none'; // 수정폼 다시 사라지게 함
                        printReplies(1, 10, true); // 가장 최근 댓글이 달린 페이지로 이동
                    }).catch(e => {
                        alert('댓글 수정 실패');
                    });
                });


            });
        });

    }

</script>


</html>