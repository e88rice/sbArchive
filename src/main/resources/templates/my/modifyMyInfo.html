<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{/layout/layout.html}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" defer></script>
<style layout:fragment="style">
  .modifyMyInfo_div {
    margin: 0 auto;
    width: 1000px;
    padding-top: 100px;
  }
  .errorMsg {
    color: red;
    font-size: 12px;
    font-weight: bold;
  }
  .hide{
    display: none;
  }
</style>

<div layout:fragment="content">
  <div class="modifyMyInfo_div">
    <div>
      <h1>회원정보 조회/수정</h1>
      <form action="/my/modifyMyInfo" method="post">
        <div class="form-group">
          <label for="email" class="form-label">Email</label>
          <div class="input-group">
            <input type="email" placeholder="email@email.com" name="email" id="email" class="form-control" readonly
                   th:value="${#authentication.principal.email}">
          </div>
        </div>
        <div class="form-group">
          <label for="userId" class="form-label">아이디</label>
          <div class="input-group">
            <input type="text" placeholder="userId" name="userId" id="userId" class="form-control" readonly=""
                   th:value="${#authentication.principal.username}">
          </div>
        </div>
        <div class="form-group">
          <label for="nickname" class="form-label">닉네임</label>
          <div class="input-group">
            <input type="text" placeholder="nickname" name="nickname" id="nickname" class="form-control"
                   th:value="${#authentication.principal.nickname}"
                   onkeyup="noNickNameSpaceForm(this)" onchange="noNickNameSpaceForm(this)">
          </div>
          <div class="failure-message5 hide errorMsg">닉네임은 2~8글자이어야 합니다</div>
          <div class="failure-message6 hide errorMsg">영어, 한글 또는 숫자만 가능합니다</div>
        </div>
        <button type="button" class="btn btn-info btnModify">수정</button>
      </form>
    </div>
  </div>
  <script th:inline="javascript">
    // 닉네임 공백 제거
    function noNickNameSpaceForm(obj) {
      let str_space = /\s/;  // 공백체크
      if(str_space.exec(obj.value)) { //공백 체크
        alert("닉네임에 공백을 포함할 수 없습니다.\n다시 입력해주세요.");
        obj.focus();
        obj.value = '';
        nicknameChecked = false;
        return false;
      }
    }

    function nicknameLength(value) {
      return value.length >= 2 && value.length <= 8
    }

    function onlyNumberAndEnglishAndKorean(str) {
      return /^[A-Za-z0-9가-힣][A-Za-z0-9가-힣]*$/.test(str);
    }

    let nicknameChecked = false;

    const nickname = document.getElementById('nickname');
    const failureMessage5 = document.querySelector('.failure-message5');
    const failureMessage6 = document.querySelector('.failure-message6');

    nickname.onkeyup = function () {
      if (nickname.value.length !== 0) { // 닉네임을 작성하기 시작했을 때
        failureMessage5.classList.remove('hide');
        if (nicknameLength(nickname.value) === false){ // 닉네임 길이는 2~8글자
          failureMessage5.classList.remove('hide');
          failureMessage6.classList.add('hide');
          nicknameChecked = false;
        }
        else if(onlyNumberAndEnglishAndKorean(nickname.value) == false){ // 영어 한글 숫자만
          failureMessage5.classList.add('hide');
          failureMessage6.classList.remove('hide');
          nicknameChecked = false;
        }
        else if(nicknameLength(nickname.value) && onlyNumberAndEnglishAndKorean(nickname.value)){
          failureMessage5.classList.add('hide');
          failureMessage6.classList.add('hide');
          nicknameChecked = true;
        }
      } else { // 닉네임을 값을 다 지우면 초기화
        failureMessage5.classList.add('hide');
        failureMessage6.classList.add('hide');
        nicknameChecked = false;
      }
    }

    const btnModify = document.querySelector('.btnModify');
    btnModify.addEventListener('click', function (e){
      e.preventDefault();
      e.stopPropagation();

      if(!nicknameChecked){
        alert("닉네임을 양식에 맞게 입력하세요");
        nickname.focus();
        return
      } else {
        document.querySelector('form').submit();
      }
    })
  </script>

</div>


</html>
<!--xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5" 시큐리티 화면 인증처리 -->