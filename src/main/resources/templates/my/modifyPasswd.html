<!DOCTYPE html>
<html lang="en"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{/layout/layout.html}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" defer></script>
<style layout:fragment="style">
  .modify_div {
    margin: 0 auto;
    width: 1000px;
    padding-top: 100px;
  }
  .hide {
    display: none;
  }
</style>

<div layout:fragment="content" class="modify_div">
  <div class="modifyMyInfo_div">
    <h1>비밀번호 재설정</h1>
    <form action="/my/modifyPasswd" method="post">
      <div class="form-group">
        <label for="passwd" class="form-label">새로운 비밀번호</label>
        <div class="input-group">
          <input type="password" placeholder="비밀번호" name="passwd" id="passwd" class="form-control">
          <div class="strongPassword-message hide">8글자 이상, 영문, 숫자, 특수문자(@$!%*#?&amp;)를 사용하세요</div>
        </div>

        <label for="passwdCheck" class="form-label">새로운 비밀번호 확인</label>
        <div class="input-group">
          <input type="password" placeholder="비밀번호 확인" name="passwdCheck" id="passwdCheck" class="form-control">
          <div class="mismatch-message2 hide">비밀번호가 일치하지 않습니다</div>
        </div>
        <div class="input-group-btn">
          <button type="button" class="btn btn-secondary modifyBtn">비밀번호 재설정</button>
          <button type="button" class="btn btn-info laterBtn">메인화면으로</button>
        </div>
      </div>
    </form>
  </div>

  <script th:inline="javascript">
    // ***** 유효성 검사 - 비밀번호 *****
    const passwd = document.getElementById("passwd");

    let isPasswordChecked = false; // 비밀번호 강화
    let isPasswordMatchChecked = false; // 비밀번호가 일치하면

    let strongPasswordMessage = document.querySelector(".strongPassword-message"); // 8글자 이상....
    let mismatchMessage2 = document.querySelector(".mismatch-message2") // 비밀번호가 일치하지 않습니다
    function strongPassword (str) {
      return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/.test(str);
    }
    function isMatch (password1, password2) {
      return password1 === password2;
    }

    passwd.onkeyup = function () {
      // console.log(passwd.value);
      // 값을 입력한 경우
      if (passwd.value.length !== 0) {
        if(strongPassword(passwd.value)) {
          strongPasswordMessage.classList.add('hide'); // 실패 메시지 Xx
          isPasswordChecked = true;
        }
        else {
          strongPasswordMessage.classList.remove('hide'); // 8글자 이상....
        }
      }
              // 값을 입력하지 않은 경우 (지웠을 때)
      // 모든 메시지를 가린다.
      else {
        strongPasswordMessage.classList.add('hide');
      }
    };
    passwdCheck.onkeyup = function () {

      // console.log(passwdCheck.value);
      if (passwdCheck.value.length !== 0) {
        if(isMatch(passwd.value, passwdCheck.value)) {
          mismatchMessage2.classList.add('hide'); // 실패 메시지 Xx
          isPasswordMatchChecked = true;
        }
        else {
          mismatchMessage2.classList.remove('hide'); // 비밀번호가 일치하지 않습니다.
        }
      }
      else {
        mismatchMessage2.classList.add('hide'); // 실패 메시지 Xx
      }
    };

    document.querySelector('.modifyBtn').addEventListener('click', function (e){
      e.preventDefault();
      e.stopPropagation();

      if(!isPasswordChecked){
        alert("비밀번호를 다시 설정해주세요")
        return;
      }
      if(!isPasswordMatchChecked){
        alert("비밀번호 재확인을 다시 입력해주세요")
        return;
      }

      document.querySelector('form').submit();
    });

    document.querySelector('.laterBtn').addEventListener('click', function (e){
      e.stopPropagation();
      e.preventDefault();

      location.href = "/index";
    });
  </script>
</div>


</html>
<!--xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5" 시큐리티 화면 인증처리 -->